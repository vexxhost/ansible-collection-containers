version = 2
root = "{{ containerd_storage_dir }}"
state = "{{ containerd_state_dir }}"
oom_score = {{ containerd_oom_score }}

[debug]
  level = "{{ containerd_debug_level | default('info') }}"

[plugins]
  [plugins."io.containerd.grpc.v1.cri"]
    sandbox_image = "{{ containerd_pause_image | vexxhost.containers.docker_image('ref') }}"
    max_container_log_line_size = {{ containerd_max_container_log_line_size }}
{% if ansible_facts['selinux'].status == 'enabled' %}
    enable_selinux = true
{% endif %}
  [plugins."io.containerd.grpc.v1.cri".registry]
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
      {% for registry in containerd_insecure_registries %}
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."{{ registry }}"]
        endpoint = ["http://{{ registry }}"]
      {% endfor %}
    [plugins."io.containerd.grpc.v1.cri".registry.configs]
      {% for registry in containerd_insecure_registries %}
      [plugins."io.containerd.grpc.v1.cri".registry.configs."{{ registry }}".tls]
        insecure_skip_verify = true
      {% endfor %}

{% if containerd_snapshotter | length %}
  {% if containerd_version.split(".")[0] == 1 %}
  [plugins."io.containerd.grpc.v1.cri".containerd]
    snapshotter = "{{ containerd_snapshotter }}"
  {% else %}
  [plugins."io.containerd.cri.v1.images"]
    snapshotter = "{{ containerd_snapshotter }}"
    {% if containerd_snapshotter_platform | length %}
  [[plugins."io.containerd.transfer.v1.local".unpack_config]]
    platform = "{{ containerd_snapshotter_platform }}"
    snapshotter = "{{ containerd_snapshotter }}"
    {% endif %}
  {% endif %}
{% endif %}
